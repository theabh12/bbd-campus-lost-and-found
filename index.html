<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BBD Campus Lost & Found</title>

  <!-- ICON -->
  <link rel="icon" href="https://bbdu.ac.in/wp-content/uploads/2018/10/favicon-300x300.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* ROOT THEME VARIABLES */
    :root {
      --bg: #0f0f23;
      --bg-card: rgba(255,255,255,0.05);
      --bg-glass: rgba(255,255,255,0.07);
      --text: #f8fafc;
      --text-light: #cbd5e1;
      --primary: #6366f1;
      --accent: #8b5cf6;
      --border: rgba(255,255,255,0.15);
    }

    /* LIGHT MODE */
    :root.light {
      --bg: #f8fafc;
      --bg-card: #ffffff;
      --bg-glass: #ffffff;
      --text: #0f172a;
      --text-light: #475569;
      --border: #d8dee9;
      --primary: #3b82f6;
      --accent: #2563eb;
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family:'Outfit', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height:100vh;
      padding-bottom:120px;
      transition: background .3s, color .3s;
    }

    header {
      text-align:center;
      margin-top:2rem;
      margin-bottom:2rem;
    }

    .logo-box {
      display:flex;
      justify-content:center;
      align-items:center;
      gap:1rem;
      background: var(--bg-card);
      padding:1.2rem 2rem;
      border-radius:50px;
      backdrop-filter:blur(12px);
      border:1px solid var(--border);
    }

    h1 {
      font-family:'Space Grotesk', sans-serif;
      font-size:2.4rem;
      background:linear-gradient(135deg, var(--primary), var(--accent));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }

    .subtitle {
      color: var(--text-light);
      font-size:1rem;
    }

    /* TABS */
    .tabs-wrapper {
      display:flex;
      justify-content:center;
      margin-top:2rem;
    }

    .tabs {
      display:flex;
      gap:1rem;
      padding:.5rem;
      background: var(--bg-card);
      border-radius:50px;
      border:1px solid var(--border);
      backdrop-filter:blur(12px);
    }

    .tab {
      padding:.8rem 2.2rem;
      background:transparent;
      border:none;
      border-radius:50px;
      cursor:pointer;
      color:var(--text-light);
      font-size:1rem;
      font-weight:600;
      transition:.3s;
    }

    .tab.active {
      background:linear-gradient(135deg, var(--primary), var(--accent));
      color:white;
    }

    /* SEARCH + USER AREA */
    .top-controls {
      display:flex;
      justify-content:center;
      gap:1rem;
      flex-wrap:wrap;
      margin-top:2rem;
    }

    .search-box {
      flex:1;
      max-width:450px;
      position:relative;
    }

    .search-input {
      width:100%;
      padding:1rem 1.4rem;
      border-radius:50px;
      background:var(--bg-card);
      border:1px solid var(--border);
      color:var(--text);
      font-size:1rem;
    }

    /* ITEM LIST */
    #itemsList {
      margin-top:2.5rem;
      max-width:800px;
      margin-left:auto;
      margin-right:auto;
      display:flex;
      flex-direction:column;
      gap:2rem;
    }

    .card {
      background:var(--bg-card);
      padding:1.5rem;
      border-radius:20px;
      border:1px solid var(--border);
      backdrop-filter:blur(10px);
      animation:fadeUp .3s ease forwards;
    }

    @keyframes fadeUp {
      from { opacity:0; transform:translateY(20px); }
      to { opacity:1; transform:translateY(0); }
    }

    /* FLOATING BUTTON */
    #addBtn {
      position:fixed;
      bottom:2rem;
      right:2rem;
      width:75px;
      height:75px;
      border-radius:50%;
      background:linear-gradient(135deg,var(--primary),var(--accent));
      color:white;
      font-size:2.5rem;
      border:none;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 12px 30px rgba(0,0,0,0.3);
      z-index:200;
    }

    /* MODALS */
    .modal {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      display:none;
      justify-content:center;
      align-items:center;
      backdrop-filter:blur(8px);
    }

    .modal-box {
      background:var(--bg-card);
      padding:2rem;
      border-radius:20px;
      border:1px solid var(--border);
      width:90%;
      max-width:500px;
      max-height:90vh;
      overflow-y:auto;
    }

    .modal-box input,
    .modal-box textarea,
    .modal-box select {
      width:100%;
      padding:1rem;
      border-radius:12px;
      background:var(--bg-glass);
      border:1px solid var(--border);
      color:var(--text);
      margin-top:.5rem;
      margin-bottom:1rem;
    }

    .modal-close {
      float:right;
      cursor:pointer;
      font-size:1.6rem;
      font-weight:bold;
      margin-top:-1rem;
    }

    /* TOGGLE MODE BUTTON */
    #themeToggle {
      position:fixed;
      top:1.5rem;
      right:1.5rem;
      background:var(--bg-card);
      border:1px solid var(--border);
      padding:.6rem 1rem;
      border-radius:12px;
      cursor:pointer;
      color:var(--text);
      font-weight:600;
    }

  </style>
</head>

<body>

<!-- LIGHT / DARK MODE TOGGLE -->
<button id="themeToggle">Toggle Theme</button>

<header>
  <div class="logo-box">
    <img src="https://bbdu.ac.in/wp-content/uploads/2018/10/favicon-300x300.png" width="60">
    <div>
      <h1>BBD Lost & Found</h1>
      <p class="subtitle">BBD Educational Group ‚Äî Premium Edition</p>
    </div>
  </div>
</header>

<!-- TABS -->
<div class="tabs-wrapper">
  <div class="tabs">
    <button class="tab active" data-tab="lost">Lost</button>
    <button class="tab" data-tab="found">Found</button>
    <button class="tab" data-tab="giveaway">Giveaway</button>
  </div>
</div>

<!-- SEARCH + USER -->
<div class="top-controls">
  <div class="search-box">
    <input id="searchInput" class="search-input" placeholder="Search items...">
  </div>
  <div id="userBox"></div>
  <button id="notifBtn">üîî</button>
  <span id="notifBadge" style="
    background:red;color:white;border-radius:50%;
    padding:3px 8px;font-size:.8rem;display:none;
  ">0</span>
</div>

<!-- MAIN ITEM LIST -->
<div id="itemsList"></div>

<!-- ADD / EDIT MODAL -->
<div id="itemModal" class="modal">
  <div class="modal-box">
    <span id="modalClose" class="modal-close">√ó</span>
    <h2 id="modalTitle">Add Item</h2>

    <label>Title</label>
    <input id="itemTitle">

    <label>Description</label>
    <textarea id="itemDesc" rows="4"></textarea>

    <label>Category</label>
    <select id="itemCategory">
      <option value="electronics">Electronics</option>
      <option value="books">Books</option>
      <option value="clothing">Clothing</option>
      <option value="accessories">Accessories</option>
      <option value="others">Others</option>
    </select>

    <label>Location</label>
    <input id="itemLocation">

    <label>Image</label>
    <input type="file" id="itemImage">

    <button id="saveItemBtn" style="
      width:100%;padding:1rem;background:linear-gradient(135deg,var(--primary),var(--accent));
      color:white;border:none;border-radius:12px;font-size:1rem;font-weight:700;
    ">Save</button>
  </div>
</div>

<button id="addBtn">+</button>
<script type="module">
/*
  PART 2 ‚Äî Supabase Auth, Session, Tabs, Load & Render Items
  Paste after PART 1 in the same index.html
*/

/* ---------- Supabase client ---------- */
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const SUPABASE_URL = "https://aksovogwimuqprevlxhd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrc292b2d3aW11cXByZXZseGhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMDQ5NzUsImV4cCI6MjA3ODc4MDk3NX0.HNsnQKEQx5rZdBLFiTV5ooch_APGrVD-noG11Dg8W2Q";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------- DOM Refs ---------- */
const tabs = Array.from(document.querySelectorAll('.tab'));
const searchInput = document.getElementById('searchInput');
const itemsList = document.getElementById('itemsList');
const addBtn = document.getElementById('addBtn');
const itemModal = document.getElementById('itemModal');
const modalClose = document.getElementById('modalClose');
const saveItemBtn = document.getElementById('saveItemBtn');
const itemTitleEl = document.getElementById('itemTitle');
const itemDescEl = document.getElementById('itemDesc');
const itemCategoryEl = document.getElementById('itemCategory');
const itemLocationEl = document.getElementById('itemLocation');
const itemImageEl = document.getElementById('itemImage');

const userBox = document.getElementById('userBox');
const notifBtn = document.getElementById('notifBtn');
const notifBadge = document.getElementById('notifBadge');

const themeToggle = document.getElementById('themeToggle');

/* ---------- State ---------- */
let currentTab = 'lost';
let state = {
  currentUser: null,
  allItems: { lost: [], found: [], giveaway: [] },
  editingId: null // if editing an item
};

/* ---------- THEME: Dark/Light toggle ---------- */
(function initTheme(){
  const root = document.documentElement;
  // default: dark, but respond to prefers-color-scheme
  if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
    root.classList.add('light');
  }
  themeToggle.onclick = () => {
    root.classList.toggle('light');
    // small feedback
    showToast('Theme toggled');
  };
})();

/* ---------- TOAST (small helper) ---------- */
const toastEl = document.getElementById('toast');
function showToast(msg, t = 2500){
  if (!toastEl) return;
  toastEl.textContent = msg;
  toastEl.style.opacity = '1';
  toastEl.style.transform = 'translateX(-50%) translateY(0)';
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=> {
    toastEl.style.opacity = '0';
    toastEl.style.transform = 'translateX(-50%) translateY(80px)';
  }, t);
}

/* ---------- AUTH UI & Handlers ---------- */
function renderUserUI(user){
  userBox.innerHTML = '';
  if (!user){
    const loginBtn = document.createElement('button');
    loginBtn.textContent = 'Login';
    loginBtn.className = 'tab';
    loginBtn.style.padding = '.6rem 1rem';
    loginBtn.onclick = () => openAuthModal('login');
    const signupBtn = document.createElement('button');
    signupBtn.textContent = 'Sign Up';
    signupBtn.className = 'tab';
    signupBtn.style.padding = '.6rem 1rem';
    signupBtn.onclick = () => openAuthModal('signup');
    userBox.appendChild(loginBtn);
    userBox.appendChild(signupBtn);
  } else {
    const nameDiv = document.createElement('div');
    nameDiv.style.display = 'inline-block';
    nameDiv.style.marginRight = '8px';
    nameDiv.textContent = user.user_metadata?.full_name || (user.email ? user.email.split('@')[0] : 'User');
    nameDiv.style.fontWeight = '700';

    const logoutBtn = document.createElement('button');
    logoutBtn.textContent = 'Logout';
    logoutBtn.className = 'tab';
    logoutBtn.style.padding = '.6rem 1rem';
    logoutBtn.onclick = async () => {
      await supabase.auth.signOut();
      showToast('Logged out');
    };

    userBox.appendChild(nameDiv);
    userBox.appendChild(logoutBtn);
  }
}

/* Auth modal (simple) */
function openAuthModal(mode='login'){
  // Create a minimal auth modal on the fly (keeps index.html minimal)
  const modal = document.createElement('div');
  modal.style.position = 'fixed';
  modal.style.inset = '0';
  modal.style.display = 'flex';
  modal.style.alignItems = 'center';
  modal.style.justifyContent = 'center';
  modal.style.background = 'rgba(0,0,0,0.6)';
  modal.style.zIndex = 9999;

  const box = document.createElement('div');
  box.style.background = 'var(--bg-card)';
  box.style.border = '1px solid var(--border)';
  box.style.padding = '1.2rem';
  box.style.borderRadius = '12px';
  box.style.width = '360px';

  const title = document.createElement('h3');
  title.textContent = mode === 'login' ? 'Login' : 'Sign Up';
  box.appendChild(title);

  const email = document.createElement('input');
  email.type = 'email';
  email.placeholder = 'Email';
  email.style.width = '100%'; email.style.padding = '10px'; email.style.marginTop = '8px';
  box.appendChild(email);

  const pass = document.createElement('input');
  pass.type = 'password';
  pass.placeholder = 'Password (6+)';
  pass.style.width = '100%'; pass.style.padding = '10px'; pass.style.marginTop = '8px';
  box.appendChild(pass);

  const action = document.createElement('button');
  action.textContent = mode === 'login' ? 'Login' : 'Sign Up';
  action.style.width = '100%'; action.style.padding = '10px'; action.style.marginTop = '12px';
  action.onclick = async () => {
    const e = email.value.trim(); const p = pass.value.trim();
    if (!e || !p || p.length < 6) { showToast('Enter valid email & password'); return; }
    try {
      if (mode === 'signup'){
        const { error } = await supabase.auth.signUp({ email: e, password: p }, { data: { full_name: e.split('@')[0] }});
        if (error) throw error;
        showToast('Signed up ‚Äî check email if confirmation required');
        document.body.removeChild(modal);
      } else {
        const { data, error } = await supabase.auth.signInWithPassword({ email: e, password: p });
        if (error) throw error;
        showToast('Logged in');
        document.body.removeChild(modal);
      }
    } catch(err){
      console.error('Auth err', err);
      showToast('Auth failed: ' + (err.message || String(err)));
    }
  };
  box.appendChild(action);

  const cancel = document.createElement('div');
  cancel.textContent = 'Cancel';
  cancel.style.marginTop = '8px';
  cancel.style.textAlign = 'center';
  cancel.style.cursor = 'pointer';
  cancel.onclick = ()=> document.body.removeChild(modal);
  box.appendChild(cancel);

  modal.appendChild(box);
  document.body.appendChild(modal);
}

/* listen to auth state changes */
supabase.auth.onAuthStateChange((event, session) => {
  state.currentUser = session?.user ?? null;
  renderUserUI(state.currentUser);
  refreshNotifications();
  loadItems(); // reload items so user-specific actions reflect
});

/* attempt initial session */
(async function(){
  try {
    const { data } = await supabase.auth.getSession();
    state.currentUser = data?.session?.user ?? null;
    renderUserUI(state.currentUser);
  } catch(e){
    console.warn('session fetch failed', e);
  }
})();

/* ---------- TABS & SEARCH ---------- */
tabs.forEach(t => t.addEventListener('click', () => {
  tabs.forEach(x => x.classList.remove('active'));
  t.classList.add('active');
  currentTab = t.dataset.tab;
  renderList();
}));

searchInput.addEventListener('input', () => {
  renderList();
});

/* ---------- Load items from Supabase ---------- */
async function loadItems(){
  try {
    // fetch all items (we'll separate by status)
    const { data, error } = await supabase
      .from('items')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(500);

    if (error) {
      console.error('loadItems error', error);
      showToast('Failed to load items');
      return;
    }

    // reset
    state.allItems = { lost: [], found: [], giveaway: [] };

    data.forEach(r => {
      const item = {
        id: r.id,
        title: r.title,
        description: r.description,
        category: r.category,
        location: r.location,
        imageURL: r.image_url || '',
        status: r.status || 'lost',
        userId: r.user_id,
        postedBy: r.posted_by || 'Anonymous',
        createdAt: r.created_at,
        likes: r.likes_count || 0,
        returned: r.status === 'returned'
      };
      if (item.status === 'found') state.allItems.found.push(item);
      else if (item.status === 'giveaway') state.allItems.giveaway.push(item);
      else state.allItems.lost.push(item);
    });

    renderList();
  } catch(err){
    console.error('loadItems exception', err);
    showToast('Load failed');
  }
}

/* ---------- Render list ---------- */
function matchesQuery(item, q){
  if (!q) return true;
  q = q.trim().toLowerCase();
  return (item.title + ' ' + item.description + ' ' + item.category + ' ' + item.location + ' ' + item.postedBy).toLowerCase().includes(q);
}

function renderList(){
  const q = (searchInput.value || '').trim().toLowerCase();
  const items = state.allItems[currentTab] || [];
  const filtered = items.filter(it => matchesQuery(it, q));

  if (!filtered.length){
    itemsList.innerHTML = `
      <div class="card" style="text-align:center;">
        <div style="font-size:32px">üîç</div>
        <h3 style="margin-top:.5rem">No items found</h3>
        <p style="color:var(--text-light)">Be the first to post in this section.</p>
      </div>
    `;
    return;
  }

  itemsList.innerHTML = '';
  filtered.forEach((item, idx) => {
    const card = document.createElement('div');
    card.className = 'card';
    // large image on top
    const media = item.imageURL ? `<div style="width:100%;height:260px;border-radius:12px;overflow:hidden;margin-bottom:12px;"><img src="${item.imageURL}" style="width:100%;height:100%;object-fit:cover;display:block" alt="${escapeHtml(item.title)}"></div>` : '';
    const created = item.createdAt ? new Date(item.createdAt).toLocaleString() : '';
    card.innerHTML = `
      ${media}
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;">
        <div style="flex:1">
          <h2 style="margin:0 0 .4rem 0;font-size:1.1rem">${escapeHtml(item.title)}</h2>
          <p style="margin:0;color:var(--text-light)">${escapeHtml(item.description)}</p>
          <div style="margin-top:.8rem;display:flex;gap:.6rem;flex-wrap:wrap">
            <span style="padding:.4rem .6rem;background:rgba(255,255,255,0.03);border-radius:999px;font-weight:700;color:var(--text-light)">${escapeHtml(item.category)}</span>
            <span style="padding:.4rem .6rem;background:rgba(255,255,255,0.03);border-radius:999px;font-weight:700;color:var(--text-light)">${escapeHtml(item.location || 'Campus')}</span>
            <span style="padding:.4rem .6rem;background:rgba(255,255,255,0.03);border-radius:999px;font-weight:700;color:var(--text-light)">${created}</span>
          </div>
          <p style="margin-top:.8rem;color:var(--text-light);font-size:.95rem">Posted by <strong>${escapeHtml(item.postedBy)}</strong></p>
        </div>

        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
          <button class="tab btn-claim" data-id="${item.id}" ${item.returned ? 'disabled' : ''}>${item.returned ? 'Returned' : 'Mark as returned'}</button>
          <button class="tab btn-like" data-id="${item.id}">üëç ${item.likes || 0}</button>
          <button class="tab btn-share" data-id="${item.id}">Share</button>
          ${ (state.currentUser && state.currentUser.id === item.userId) ? `<button class="tab btn-edit" data-id="${item.id}">Edit</button><button class="tab btn-delete" data-id="${item.id}">Delete</button>` : `<button class="tab btn-report" data-id="${item.id}">Report</button>` }
        </div>
      </div>
    `;

    // attach buttons if handler exists (handlers provided in PART 3)
    setTimeout(()=> {
      const claimBtn = card.querySelector('.btn-claim');
      if (claimBtn) claimBtn.addEventListener('click', ()=> {
        if (typeof handleMarkReturned === 'function') handleMarkReturned(item);
        else showToast('Action pending...');
      });

      const likeBtn = card.querySelector('.btn-like');
      if (likeBtn) likeBtn.addEventListener('click', ()=> {
        if (typeof handleLike === 'function') handleLike(item);
        else showToast('Action pending...');
      });

      const shareBtn = card.querySelector('.btn-share');
      if (shareBtn) shareBtn.addEventListener('click', ()=> {
        const text = `Item: ${item.title}\nLocation: ${item.location}\n${item.description}\nOpen: ${location.href}`;
        window.open('https://wa.me/?text=' + encodeURIComponent(text), '_blank');
      });

      const editBtn = card.querySelector('.btn-edit');
      if (editBtn) editBtn.addEventListener('click', ()=> {
        if (typeof openEditModal === 'function') openEditModal(item);
        else showToast('Edit not available');
      });

      const delBtn = card.querySelector('.btn-delete');
      if (delBtn) delBtn.addEventListener('click', ()=> {
        if (typeof handleDelete === 'function') handleDelete(item);
        else showToast('Delete not available');
      });

      const reportBtn = card.querySelector('.btn-report');
      if (reportBtn) reportBtn.addEventListener('click', ()=> {
        if (typeof handleReport === 'function') handleReport(item);
        else showToast('Report not available');
      });
    }, 30);

    itemsList.appendChild(card);
  });
}

/* ---------- Utilities ---------- */
function escapeHtml(s){
  if (s == null) return '';
  return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

/* ---------- Modal open/close ---------- */
addBtn.addEventListener('click', ()=>{
  if (!state.currentUser) {
    openAuthModal('login');
    showToast('Login to post');
    return;
  }
  state.editingId = null;
  document.getElementById('modalTitle').textContent = 'Add Item';
  itemTitleEl.value = '';
  itemDescEl.value = '';
  itemCategoryEl.value = 'electronics';
  itemLocationEl.value = '';
  itemImageEl.value = '';
  itemModal.style.display = 'flex';
});

modalClose.addEventListener('click', ()=> {
  itemModal.style.display = 'none';
  state.editingId = null;
});

/* ---------- Initial load ---------- */
(async function init(){
  await loadItems();
  // refresh periodically
  setInterval(()=> loadItems(), 60_000);
})();
</script>
<script type="module">
/* ============================================================
   PART 3 ‚Äî Posting, Editing, Deleting, Likes, Reports,
             Notifications, Realtime Updates
   ============================================================ */

/* We continue from Supabase client & state defined in PART 2 */
import imageCompression from "https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.esm.js";

/* ========== IMAGE UPLOAD HANDLER ========== */
async function compressAndUpload(file){
  if (!file) return "";

  try {
    const compressed = await imageCompression(file, {
      maxSizeMB: 1,
      maxWidthOrHeight: 1200,
      useWebWorker: true
    });

    const filename = `img_${Date.now()}_${Math.random().toString(36).slice(2)}.webp`;
    const { error: uploadErr } = await supabase.storage
      .from("images")
      .upload(filename, compressed, {
        contentType: "image/webp",
        upsert: false
      });

    if (uploadErr) {
      console.error(uploadErr);
      showToast("Image upload failed");
      return "";
    }

    const { data } = supabase.storage.from("images").getPublicUrl(filename);
    return data?.publicUrl || "";

  } catch (err) {
    console.error("Compression/upload error", err);
    return "";
  }
}

/* ========== SAVE / POST ITEM ========== */
saveItemBtn.addEventListener("click", async () => {
  if (!state.currentUser) {
    openAuthModal("login");
    showToast("Login to post");
    return;
  }

  const title = itemTitleEl.value.trim();
  const desc = itemDescEl.value.trim();
  const category = itemCategoryEl.value;
  const location = itemLocationEl.value.trim();
  const file = itemImageEl.files[0] || null;

  if (!title || !desc) {
    showToast("Fill title and description");
    return;
  }

  saveItemBtn.disabled = true;
  saveItemBtn.textContent = state.editingId ? "Saving..." : "Posting...";

  try {
    let imageURL = "";
    if (file) {
      imageURL = await compressAndUpload(file);
    }

    if (state.editingId) {
      /* UPDATE ITEM */
      const { error } = await supabase
        .from("items")
        .update({
          title,
          description: desc,
          category,
          location,
          image_url: imageURL || undefined,
          updated_at: new Date()
        })
        .eq("id", state.editingId);

      if (error) throw error;
      showToast("Updated");

    } else {
      /* NEW ITEM */
      const { error } = await supabase.from("items").insert([
        {
          title,
          description: desc,
          category,
          location,
          image_url: imageURL,
          status: currentTab, // lost / found / giveaway
          user_id: state.currentUser?.id || null,
          posted_by: state.currentUser?.email?.split("@")[0] || "User"
        }
      ]);

      if (error) throw error;

      /* NOTIFICATION: NEW ITEM */
      await createNotification(
        `New ${currentTab} item`,
        `${title} added in ${currentTab}`,
        "all"
      );

      showToast("Posted successfully");
    }

    // close modal + reset form
    itemModal.style.display = "none";
    state.editingId = null;
    itemTitleEl.value = "";
    itemDescEl.value = "";
    itemCategoryEl.value = "electronics";
    itemLocationEl.value = "";
    itemImageEl.value = "";

    await loadItems();

  } catch (err) {
    console.error(err);
    showToast("Post failed");
  }

  saveItemBtn.disabled = false;
  saveItemBtn.textContent = "Save";
});

/* ========== EDIT ITEM ========== */
function openEditModal(item) {
  if (!state.currentUser) {
    openAuthModal("login");
    showToast("Login to edit");
    return;
  }

  if (state.currentUser.id !== item.userId) {
    showToast("You can only edit your own items");
    return;
  }

  state.editingId = item.id;
  document.getElementById("modalTitle").textContent = "Edit Item";

  itemTitleEl.value = item.title;
  itemDescEl.value = item.description;
  itemCategoryEl.value = item.category;
  itemLocationEl.value = item.location;

  itemImageEl.value = "";
  itemModal.style.display = "flex";
}

/* ========== DELETE ITEM ========== */
async function handleDelete(item) {
  if (!state.currentUser) {
    openAuthModal("login");
    return;
  }
  if (state.currentUser.id !== item.userId) {
    showToast("Not your item");
    return;
  }

  if (!confirm("Delete this item?")) return;

  try {
    await supabase.from("items").delete().eq("id", item.id);
    showToast("Deleted");
    await loadItems();
  } catch (err) {
    console.error(err);
    showToast("Delete failed");
  }
}

/* ========== REPORT ITEM ========== */
async function handleReport(item) {
  const reason = prompt("Why are you reporting this item?");
  if (!reason) return;

  try {
    await supabase.from("reports").insert([
      {
        item_id: item.id,
        user_id: state.currentUser?.id || null,
        reason
      }
    ]);

    showToast("Reported ‚Äî thank you");
  } catch (err) {
    console.error(err);
    showToast("Report failed");
  }
}

/* ========== LIKE ITEM ========== */
async function handleLike(item) {
  if (!state.currentUser) {
    openAuthModal("login");
    return;
  }

  try {
    // try inserting
    const { error } = await supabase.from("likes").insert({
      item_id: item.id,
      user_id: state.currentUser.id
    });

    if (error) {
      // means already liked ‚Üí remove like
      await supabase
        .from("likes")
        .delete()
        .match({ item_id: item.id, user_id: state.currentUser.id });
    }

    await loadItems();
  } catch (err) {
    console.error(err);
    showToast("Like failed");
  }
}

/* ========== MARK AS RETURNED ========== */
async function handleMarkReturned(item) {
  if (!state.currentUser) {
    openAuthModal("login");
    return;
  }

  try {
    await supabase.from("items").update({ status: "returned" }).eq("id", item.id);

    await createNotification(
      "Item returned",
      `${item.title} was marked as returned`,
      "all"
    );

    showToast("Marked returned");
    await loadItems();
  } catch (err) {
    console.error(err);
    showToast("Failed to mark returned");
  }
}

/* ========== NOTIFICATIONS ========== */
async function createNotification(title, message, target = "all") {
  try {
    await supabase.from("notifications").insert([
      {
        title,
        message,
        target,
        read_by: []
      }
    ]);
  } catch (err) {
    console.warn("Notif error", err);
  }
}

/* ========== REALTIME NOTIFICATION BADGE ========== */
async function refreshNotifications() {
  if (!state.currentUser) {
    notifBadge.style.display = "none";
    return;
  }

  try {
    const { data } = await supabase
      .from("notifications")
      .select("*")
      .limit(100)
      .order("created_at", { ascending: false });

    const unread = data.filter(
      n => !(n.read_by || []).includes(state.currentUser.id)
    ).length;

    if (unread > 0) {
      notifBadge.textContent = unread;
      notifBadge.style.display = "inline-block";
    } else {
      notifBadge.style.display = "none";
    }
  } catch (err) {
    console.error(err);
  }
}

/* ========== NOTIFICATION PANEL ========== */
notifBtn.addEventListener("click", async () => {
  if (!state.currentUser) {
    openAuthModal("login");
    return;
  }

  const { data } = await supabase
    .from("notifications")
    .select("*")
    .order("created_at", { ascending: false });

  const panel = document.createElement("div");
  panel.style.position = "fixed";
  panel.style.top = "100px";
  panel.style.right = "20px";
  panel.style.width = "380px";
  panel.style.maxHeight = "60vh";
  panel.style.overflowY = "auto";
  panel.style.background = "var(--bg-card)";
  panel.style.border = "1px solid var(--border)";
  panel.style.padding = "1rem";
  panel.style.borderRadius = "12px";
  panel.style.zIndex = 9999;

  panel.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <strong>Notifications</strong>
      <button id="closeNotif">‚úñ</button>
    </div>
  `;

  data.forEach(n => {
    const unread = !(n.read_by || []).includes(state.currentUser.id);
    const div = document.createElement("div");
    div.style.padding = "10px";
    div.style.marginBottom = "10px";
    div.style.borderRadius = "8px";
    div.style.background = unread ? "rgba(255,255,255,0.07)" : "transparent";
    div.style.cursor = "pointer";

    div.innerHTML = `
      <strong>${escapeHtml(n.title)}</strong>
      <p style="color:var(--text-light)">${escapeHtml(n.message)}</p>
      <small style="color:var(--text-light)">${new Date(n.created_at).toLocaleString()}</small>
    `;

    div.onclick = async () => {
      const arr = n.read_by || [];
      if (!arr.includes(state.currentUser.id)) arr.push(state.currentUser.id);

      await supabase
        .from("notifications")
        .update({ read_by: arr })
        .eq("id", n.id);

      panel.remove();
      refreshNotifications();
    };

    panel.appendChild(div);
  });

  document.body.appendChild(panel);
  document.getElementById("closeNotif").onclick = () => panel.remove();
});

/* ========== REALTIME LISTENER ========== */
const channel = supabase
  .channel("realtime-items")
  .on(
    "postgres_changes",
    { event: "INSERT", schema: "public", table: "items" },
    payload => {
      showToast("New item posted");
      loadItems();
    }
  )
  .subscribe();


</script>

<!-- TOAST ELEMENT -->
<div id="toast" style="
  position:fixed; bottom:2rem; left:50%;
  transform:translateX(-50%) translateY(80px);
  background:var(--bg-card);
  padding:1rem 2rem; border-radius:50px;
  border:1px solid var(--border);
  color:var(--text); opacity:0;
  transition:.4s; z-index:9999;
"></div>
