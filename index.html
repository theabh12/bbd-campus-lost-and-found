<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BBD Campus Lost & Found — Final (Redesigned)</title>
  <!-- Favicon (BBD logo) -->
  <link rel="icon" href="https://bbdu.ac.in/wp-content/uploads/2018/10/favicon-300x300.png" />
  <meta name="theme-color" content="#1f6feb" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#f6fbff; --bg2:#eaf6ff;
      --glass: rgba(255,255,255,0.84);
      --glass-strong: rgba(255,255,255,0.92);
      --muted:#5f6a76;
      --accent:#1f6feb; --accent-2:#2b8df6;
      --danger:#ef4444; --success:#10b981;
      --card-border: rgba(255,255,255,0.7);
      --shadow: 0 16px 50px rgba(16,24,40,0.06);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;color:#071124;background:linear-gradient(135deg,var(--bg1),var(--bg2));-webkit-font-smoothing:antialiased;min-height:100vh;opacity:0;transform:translateY(6px);transition:opacity .28s ease,transform .28s ease}
    body.ready{opacity:1;transform:none}
    .app{max-width:1200px;margin:28px auto;padding:20px}
    /* header */
    header{display:flex;flex-direction:column;align-items:center;gap:10px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:64px;height:64px;border-radius:12px;overflow:hidden;box-shadow:0 12px 30px rgba(31,99,255,0.08);background:#fff}
    .logo img{width:100%;height:100%;object-fit:cover}
    .app-title{font-weight:800;font-size:22px}
    .app-sub{font-size:13px;color:var(--muted)}
    /* centered tabs (under title) - BIGGER */
    .tabs{display:flex;gap:18px;justify-content:center;margin-top:12px}
    .tab{padding:18px 32px;border-radius:999px;background:transparent;border:1px solid transparent;cursor:pointer;font-weight:800;font-size:18px;color:var(--muted);transition:transform .12s,background .12s}
    .tab:hover{transform:translateY(-4px)}
    .tab.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;box-shadow:0 12px 30px rgba(31,99,255,0.10)}
    /* controls */
    .controls{display:flex;gap:10px;align-items:center;margin:12px 0;justify-content:center;flex-wrap:wrap}
    .search{padding:10px 14px;border-radius:10px;border:1px solid rgba(11,17,36,0.06);min-width:360px}
    .btn{padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:700;cursor:pointer;box-shadow:0 12px 30px rgba(31,99,255,0.08);transition:transform .12s}
    .btn:hover{transform:translateY(-2px)}
    .btn.ghost{background:transparent;border:1px solid var(--card-border);color:var(--muted)}
    .btn.danger{background:linear-gradient(90deg,#ff7a7a,#ff4b4b)}
    .inbox{position:relative;display:inline-block}
    .badge{position:absolute;right:-10px;top:-10px;background:var(--danger);color:#fff;width:20px;height:20px;border-radius:999px;display:flex;align-items:center;justify-content:center;font-size:12px;box-shadow:0 8px 20px rgba(239,68,68,0.16)}
    /* grid single column full width cards - BIGGER */
    .list{display:flex;flex-direction:column;gap:20px;margin-top:10px}
    .card{
      display:flex;gap:24px;align-items:flex-start;background:linear-gradient(180deg,rgba(255,255,255,0.98),rgba(250,252,255,0.98));
      border-radius:16px;padding:28px;border:1px solid var(--card-border);box-shadow:var(--shadow);transition:transform .12s,box-shadow .12s;
      width:100%;
    }
    .card:hover{transform:translateY(-6px);box-shadow:0 30px 60px rgba(16,24,40,0.08)}
    .card-media{width:380px;height:260px;border-radius:12px;background:#f3f7ff;flex-shrink:0;object-fit:cover}
    .card-body{flex:1;display:flex;flex-direction:column;gap:12px}
    .card-title{font-weight:800;font-size:24px}
    .card-desc{color:var(--muted);font-size:16px;line-height:1.6}
    .meta-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .pill{padding:8px 14px;border-radius:999px;background:#f1f7ff;font-weight:700;font-size:15px;color:var(--muted)}
    .card-foot{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    .claim{padding:14px 20px;border-radius:10px;border:0;background:linear-gradient(90deg,#ff7a7a,#ff4b4b);color:#fff;font-weight:800;font-size:16px;cursor:pointer}
    .claimed{background:#94f0b7;color:#04572a}
    /* empty state */
    .empty{display:flex;flex-direction:column;align-items:center;gap:12px;padding:28px;border-radius:12px;background:var(--glass);border:1px solid var(--card-border)}
    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(6,9,15,0.36);z-index:999}
    .modal.show{display:flex}
    .panel{width:760px;max-width:96%;background:var(--glass-strong);padding:18px;border-radius:12px;border:1px solid var(--card-border);box-shadow:0 40px 80px rgba(9,16,56,0.12);backdrop-filter:blur(8px)}
    .single-box{width:100%;min-height:120px;padding:14px;border-radius:12px;border:1px solid rgba(15,23,42,0.06);resize:vertical}
    .form-row{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .input-field{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);font-size:14px;margin-bottom:10px}
    .auth-toggle{text-align:center;margin-top:12px;color:var(--muted);font-size:14px}
    .auth-toggle a{color:var(--accent);cursor:pointer;font-weight:700;text-decoration:none}
    .auth-toggle a:hover{text-decoration:underline}
    .info-box{background:#eaf6ff;padding:12px;border-radius:8px;margin-bottom:12px;border-left:4px solid var(--accent)}
    .info-box p{margin:0;font-size:13px;color:var(--muted)}
    /* fab BIGGER bottom-right */
    .fab{position:fixed;right:32px;bottom:32px;width:100px;height:100px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#fff;font-size:52px;box-shadow:0 22px 50px rgba(31,99,255,0.20);cursor:pointer;z-index:1500;transition:transform .2s}
    .fab:hover{transform:translateY(-6px) scale(1.05)}
    /* notification panel */
    .notif-panel{position:fixed;right:22px;top:92px;width:400px;background:var(--glass-strong);border-radius:12px;padding:10px;border:1px solid var(--card-border);box-shadow:0 30px 60px rgba(9,16,56,0.12);display:none;z-index:1200}
    .notif-panel.show{display:block}
    .notif-item{padding:10px;border-radius:10px;margin-bottom:8px;background:linear-gradient(180deg,rgba(255,255,255,0.96),rgba(250,252,255,0.96));cursor:pointer}
    .notif-item.unread{box-shadow:0 12px 30px rgba(31,99,255,0.06)}
    /* particles canvas */
    #particles{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:1600}
    /* toast */
    .toast{position:fixed;right:18px;bottom:18px;background:#0b1220;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 16px 40px rgba(11,17,36,0.28);z-index:2000;opacity:0;transform:translateY(8px);transition:opacity .28s,transform .28s}
    /* footer */
    footer{margin-top:40px;padding:20px;text-align:center;color:var(--muted);font-size:14px}
    footer a{color:var(--accent);text-decoration:none;font-weight:700}
    footer a:hover{text-decoration:underline}
    /* responsive */
    @media (max-width:820px){
      .card{flex-direction:column}
      .card-media{width:100%;height:240px}
      .search{min-width:100%}
      .panel{width:92%}
      .tabs{flex-wrap:wrap}
      .tab{padding:14px 24px;font-size:16px}
    }
  </style>
</head>
<body>
  <div id="particles"><canvas id="pcanvas" style="width:100%;height:100%"></canvas></div>
  <div class="app" id="appRoot">
    <header>
      <div class="brand">
        <div class="logo"><img src="https://bbdu.ac.in/wp-content/uploads/2018/10/favicon-300x300.png" alt="BBD" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=64 height=64><rect width=64 height=64 rx=12 fill=%22%231f6feb%22/></svg>'" style="width:100%;height:100%;object-fit:cover"></div>
        <div style="text-align:center">
          <div class="app-title">Campus Lost & Found</div>
          <div class="app-sub">BBD Educational Group — campus item sharing</div>
        </div>
      </div>
      <!-- centered tabs under title -->
      <div class="tabs" role="tablist" aria-label="Sections">
        <div class="tab active" data-tab="lost">Lost</div>
        <div class="tab" data-tab="found">Found</div>
        <div class="tab" data-tab="giveaway">Giveaway</div>
      </div>
      <div class="controls">
        <input id="search" class="search" placeholder="Search title / description..." />
        <div class="inbox">
          <button id="inboxBtn" class="btn ghost">Inbox</button>
          <div id="badge" class="badge" style="display:none">0</div>
        </div>
        <div id="userArea"></div>
      </div>
    </header>
    <!-- item list (single column) -->
    <main>
      <section id="list" class="list">
        <!-- skeleton cards until Firestore loads -->
        <div class="card" style="height:180px">
          <div style="flex:1">
            <div class="card-title" style="background:#f3f6ff;height:24px;width:60%;border-radius:6px"></div>
          </div>
        </div>
        <div class="card" style="height:180px"></div>
        <div class="card" style="height:180px"></div>
      </section>
    </main>
    <!-- footer with contributors link -->
    <footer>
      <p>Made with ❤️ by BBD Students | <a href="contributors.html">View Contributors</a></p>
      <p style="margin-top:8px;font-size:12px">Lost something? Found something? Share it here and help the community!</p>
    </footer>
  </div>
  <!-- notification panel -->
  <div id="notifPanel" class="notif-panel"></div>
  <!-- modal for Add Item -->
  <div id="modalAdd" class="modal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Post an Item</h3>
        <button id="closeModalAdd" style="border:0;background:transparent;font-size:20px;cursor:pointer">✕</button>
      </div>
      <div style="margin-top:12px">
        <label style="font-size:14px;color:var(--muted)">Describe your item in one line</label>
        <textarea id="singleBox" class="single-box" placeholder="Lost — Black Wallet near Canteen — contact@mail.com"></textarea>
        <div class="form-row">
          <input id="fileInput" type="file" accept="image/*" />
          <select id="category" style="padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.06)">
            <option value="other">Category: Other</option>
            <option value="electronics">Electronics</option>
            <option value="books">Books</option>
            <option value="notes">Notes</option>
            <option value="clothing">Clothing</option>
          </select>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button id="postBtn" class="btn">Post Item</button>
        </div>
      </div>
    </div>
  </div>
  <!-- modal for Login/Signup -->
  <div id="modalAuth" class="modal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" style="max-width:480px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="authTitle">Login to Your Account</h3>
        <button id="closeModalAuth" style="border:0;background:transparent;font-size:20px;cursor:pointer">✕</button>
      </div>
      <div id="authArea" style="margin-top:16px">
        <!-- Info box -->
        <div id="authInfo" class="info-box">
          <p><strong>First time?</strong> Click "Sign Up" below to create an account.</p>
        </div>
        <label style="font-size:14px;font-weight:600;margin-bottom:4px;display:block">Email</label>
        <input id="authEmail" type="email" class="input-field" placeholder="your-email@example.com" />
        
        <label style="font-size:14px;font-weight:600;margin-bottom:4px;display:block">Password</label>
        <input id="authPass" type="password" class="input-field" placeholder="Min 6 characters" />
        
        <div style="display:flex;gap:8px;margin-top:16px">
          <button id="authActionBtn" class="btn" style="flex:1">Login</button>
        </div>
        <div class="auth-toggle">
          <span id="authToggleText">Don't have an account? <a id="authToggleLink">Sign Up</a></span>
        </div>
      </div>
    </div>
  </div>
  <!-- big floating add button -->
  <div id="fab" class="fab" title="Add Item">+</div>
  <!-- toast container -->
  <div id="toastRoot"></div>
  <script type="module">
  // Firebase + UI glue (single-file final)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, updateDoc, doc, arrayUnion, limit, getDocs } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";
  // your firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyA6fg0gFPowPWZVOajkkznj9xocVp3evQs",
    authDomain: "bbd-campus-lost-and-found.firebaseapp.com",
    projectId: "bbd-campus-lost-and-found",
    storageBucket: "bbd-campus-lost-and-found.appspot.com",
    messagingSenderId: "519626476206",
    appId: "1:519626476206:web:62b07f0bc143499c7a3b3f",
    measurementId: "G-NQZWGG3717"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);
  // EmailJS configuration (REPLACE WITH YOUR OWN KEYS)
  const EMAILJS_SERVICE_ID = "service_qczf199"; // Replace with your EmailJS service ID
  const EMAILJS_TEMPLATE_ID = "template_yeab3wq"; // Replace with your EmailJS template ID
  const EMAILJS_PUBLIC_KEY = "RERxK16JreItz1BAB"; // Replace with your EmailJS public key
  // Load EmailJS SDK
  const emailjsScript = document.createElement('script');
  emailjsScript.src = "https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js";
  emailjsScript.onload = () => {
    if(window.emailjs && EMAILJS_PUBLIC_KEY !== "YOUR_PUBLIC_KEY") {
      emailjs.init(EMAILJS_PUBLIC_KEY);
    }
  };
  document.head.appendChild(emailjsScript);
  // UI refs
  const list = document.getElementById('list');
  const search = document.getElementById('search');
  const inboxBtn = document.getElementById('inboxBtn');
  const badge = document.getElementById('badge');
  const notifPanel = document.getElementById('notifPanel');
  const modalAdd = document.getElementById('modalAdd');
  const modalAuth = document.getElementById('modalAuth');
  const closeModalAdd = document.getElementById('closeModalAdd');
  const closeModalAuth = document.getElementById('closeModalAuth');
  const fab = document.getElementById('fab');
  const singleBox = document.getElementById('singleBox');
  const fileInput = document.getElementById('fileInput');
  const postBtn = document.getElementById('postBtn');
  const authEmail = document.getElementById('authEmail');
  const authPass = document.getElementById('authPass');
  const authActionBtn = document.getElementById('authActionBtn');
  const authToggleLink = document.getElementById('authToggleLink');
  const authTitle = document.getElementById('authTitle');
  const authInfo = document.getElementById('authInfo');
  const authToggleText = document.getElementById('authToggleText');
  const userArea = document.getElementById('userArea');
  const tabs = document.querySelectorAll('.tab');
  const postCategory = document.getElementById('category');
  const pcanvas = document.getElementById('pcanvas');
  const ctx = pcanvas.getContext('2d');
  const toastRoot = document.getElementById('toastRoot');
  // state
  let currentTab = 'lost';
  let itemsUnsub = null;
  let notifsUnsub = null;
  let currentUser = null;
  let authMode = 'login'; // 'login' or 'signup'
  // canvas resize
  function resizeCanvas(){ pcanvas.width = window.innerWidth; pcanvas.height = window.innerHeight; }
  window.addEventListener('resize', resizeCanvas); resizeCanvas();
  // show page
  requestAnimationFrame(()=>document.body.classList.add('ready'));
  // AUTH UI
  function renderUser(user){
    userArea.innerHTML = '';
    if (!user){
      const l = document.createElement('button'); l.className='btn ghost'; l.textContent='Login';
      const s = document.createElement('button'); s.className='btn'; s.textContent='Sign up';
      l.onclick = () => openAuthModal('login'); 
      s.onclick = () => openAuthModal('signup');
      userArea.appendChild(l); userArea.appendChild(s);
    } else {
      const name = document.createElement('div'); 
      name.style.fontWeight='700'; 
      name.style.marginRight='10px';
      name.textContent = user.displayName || user.email.split('@')[0];
      const out = document.createElement('button'); out.className='btn ghost'; out.textContent='Logout';
      out.onclick = async ()=>{ await signOut(auth); showToast('Logged out'); };
      userArea.appendChild(name); userArea.appendChild(out);
    }
  }
  function openAuthModal(mode = 'login'){
    authMode = mode;
    if(mode === 'login'){
      authTitle.textContent = 'Login to Your Account';
      authActionBtn.textContent = 'Login';
      authInfo.innerHTML = '<p><strong>First time?</strong> Click "Sign Up" below to create an account.</p>';
      authToggleText.innerHTML = 'Don\'t have an account? <a id="authToggleLink">Sign Up</a>';
    } else {
      authTitle.textContent = 'Create New Account';
      authActionBtn.textContent = 'Sign Up';
      authInfo.innerHTML = '<p><strong>Already have an account?</strong> Click "Login" below.</p>';
      authToggleText.innerHTML = 'Already have an account? <a id="authToggleLink">Login</a>';
    }
    
    // Re-attach toggle listener
    const newToggle = document.getElementById('authToggleLink');
    newToggle.onclick = () => openAuthModal(authMode === 'login' ? 'signup' : 'login');
    
    modalAuth.classList.add('show');
    authEmail.value = '';
    authPass.value = '';
  }
  function openAddModal(){
    if (!currentUser) {
      openAuthModal('login');
      showToast('Please login first to post items');
      return;
    }
    modalAdd.classList.add('show');
  }
  closeModalAdd.onclick = () => { modalAdd.classList.remove('show'); singleBox.value=''; fileInput.value=''; };
  closeModalAuth.onclick = () => { modalAuth.classList.remove('show'); };
  fab.onclick = openAddModal;
  // Auth action button
  authActionBtn.onclick = async () => {
    const email = authEmail.value.trim();
    const pass = authPass.value.trim();
    
    if(!email || !pass) {
      showToast('❌ Please enter email and password');
      return;
    }
    
    if(pass.length < 6) {
      showToast('❌ Password must be at least 6 characters');
      return;
    }
    
    try {
      if(authMode === 'signup'){
        await createUserWithEmailAndPassword(auth, email, pass);
        showToast('✅ Account created successfully!');
        modalAuth.classList.remove('show');
        // Add user to Firestore
        try {
          await addDoc(collection(db,'users'), { 
            uid: auth.currentUser.uid, 
            email: email, 
            name: email.split('@')[0], 
            createdAt: serverTimestamp() 
          });
        } catch(e){ console.warn('User doc creation failed', e); }
      } else {
        await signInWithEmailAndPassword(auth, email, pass);
        showToast('✅ Logged in successfully!');
        modalAuth.classList.remove('show');
      }
    } catch(e) {
      console.error('Auth error:', e);
      if(authMode === 'login'){
        if(e.code === 'auth/user-not-found' || e.code === 'auth/invalid-credential'){
          showToast('❌ No account found. Please Sign Up first!');
          setTimeout(() => openAuthModal('signup'), 1500);
        } else if(e.code === 'auth/wrong-password'){
          showToast('❌ Wrong password. Try again.');
        } else {
          showToast('❌ Login failed: ' + e.message);
        }
      } else {
        if(e.code === 'auth/email-already-in-use'){
          showToast('❌ Email already exists. Please Login instead.');
          setTimeout(() => openAuthModal('login'), 1500);
        } else {
          showToast('❌ Signup failed: ' + e.message);
        }
      }
    }
  };
  // Enter key support
  authEmail.addEventListener('keypress', (e) => { if(e.key === 'Enter') authActionBtn.click(); });
  authPass.addEventListener('keypress', (e) => { if(e.key === 'Enter') authActionBtn.click(); });
  onAuthStateChanged(auth, async user => {
    currentUser = user; 
    renderUser(user); 
    attachNotificationsListener(); 
    attachItemsListener(currentTab);
  });
  // TAB handling
  tabs.forEach(t=> t.addEventListener('click', ()=>{ 
    tabs.forEach(x=>x.classList.remove('active')); 
    t.classList.add('active'); 
    currentTab = t.dataset.tab; 
    attachItemsListener(currentTab); 
  }));
  // Attach items listener
  function attachItemsListener(tabName){
    if (itemsUnsub){ itemsUnsub(); itemsUnsub=null; }
    list.innerHTML = '';
    // show skeleton
    for (let i=0;i<2;i++){ const s = document.createElement('div'); s.className='card'; s.style.height='180px'; list.appendChild(s); }
    const q = query(collection(db, tabName), orderBy('createdAt','desc'), limit(80));
    itemsUnsub = onSnapshot(q, snap => {
      const arr = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      renderList(arr);
    }, err => { list.innerHTML = `<div class="card">Failed to load: ${err.message}</div>`; });
  }
  function renderList(items){
    const q = search.value.trim().toLowerCase();
    const filtered = items.filter(it => {
      if (!q) return true;
      return ((it.title||'') + ' ' + (it.description||'')).toLowerCase().includes(q);
    });
    if (!filtered.length){ list.innerHTML = `<div class="empty"><svg viewBox="0 0 64 48" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><rect width="64" height="48" rx="8" fill="#f0f6ff"/><path d="M9 34c3-6 10-10 19-10s16 4 19 10" stroke="#cfe7ff" stroke-width="2" stroke-linecap="round"/><circle cx="44" cy="20" r="6" fill="#dfefff"/></g></svg><div style="font-weight:700">Nothing here yet</div><div class="small-muted">No items posted in this section — be the first to add one.</div></div>`; return; }
    list.innerHTML = '';
    filtered.forEach(it => {
      const c = document.createElement('div'); c.className='card';
      const media = it.imageURL ? `<img src="${it.imageURL}" class="card-media">` : `<div class="card-media"></div>`;
      c.innerHTML = `
        ${media}
        <div class="card-body">
          <div class="card-title">${escapeHtml(it.title||'Untitled')}</div>
          <div class="card-desc">${escapeHtml(it.description||'')}</div>
          <div class="meta-row">
            <div class="pill">${escapeHtml(it.location||'Campus')}</div>
            <div class="pill">${escapeHtml(it.category||'')}</div>
          </div>
          <div class="card-foot">
            <div class="small-muted">By ${escapeHtml(it.posterName||'Unknown')}</div>
            <div>
              <button class="claim ${it.claimed ? 'claimed' : ''}" ${it.claimed ? 'disabled' : ''}>${it.claimed ? 'Claimed' : 'Claim'}</button>
            </div>
          </div>
        </div>
      `;
      // claim handler
      const claimBtn = c.querySelector('.claim');
      claimBtn && claimBtn.addEventListener('click', async () => {
        if (!currentUser) { openAuthModal('login'); showToast('Please login to claim items'); return; }
        try {
          await updateDoc(doc(db, currentTab, it.id), { claimed: true });
          await addDoc(collection(db,'notifications'), { title: 'Item Claimed', message: `${it.title || 'An item'} was claimed in ${currentTab}.`, target:'all', itemId: it.id, createdAt: serverTimestamp(), readBy: [] });
          const rect = claimBtn.getBoundingClientRect();
          particleBurst({ x: rect.left + rect.width/2, y: rect.top + rect.height/2, count: 32 });
          showToast('✅ Claim registered — owner will contact via email');
          // Send email notification
          await sendEmailToAllUsers('Item Claimed', `${it.title} has been claimed!`);
        } catch(e){ showToast('❌ Claim failed: '+e.message); }
      });
      // owner delete
      if (currentUser && currentUser.uid === it.postedBy){
        const del = document.createElement('button'); del.className='btn ghost'; del.textContent='Delete';
        del.onclick = async () => { if (!confirm('Delete item?')) return; try { await updateDoc(doc(db,currentTab,it.id), { deleted:true }); showToast('Item deleted'); } catch(e){ showToast('❌ Delete failed: '+e.message); } };
        c.querySelector('.card-foot div').appendChild(del);
      }
      list.appendChild(c);
    });
  }
  // Upload image to Firebase Storage
  async function uploadImageToCloud(file) {
    try {
      const timestamp = Date.now();
      const filename = `items/${timestamp}_${file.name}`;
      const storageRef = ref(storage, filename);
      
      showToast('Uploading image...');
      await uploadBytes(storageRef, file);
      const downloadURL = await getDownloadURL(storageRef);
      showToast('✅ Image uploaded successfully!');
      return downloadURL;
    } catch(e) {
      console.error('Cloud upload failed:', e);
      showToast('⚠️ Image upload failed, using fallback');
      return await fileToDataUrl(file);
    }
  }
  // post item
  postBtn.onclick = async () => {
    if (!currentUser) { openAuthModal('login'); showToast('Please login first'); return; }
    const raw = singleBox.value.trim(); if (!raw) { showToast('❌ Please type item details'); return; }
    let title = raw.split('—')[0] || raw.split('-')[0] || raw; title = title.trim().slice(0,120);
    const description = raw; const location = 'Campus'; const category = postCategory.value || 'other';
    const file = fileInput.files[0]; let imageURL = '';
    
    if (file){
      imageURL = await uploadImageToCloud(file);
    }
    
    try {
      await addDoc(collection(db,currentTab), { title, description, location, category, imageURL: imageURL||'', postedBy: currentUser.uid, posterName: currentUser.displayName||currentUser.email, claimed:false, createdAt: serverTimestamp() });
      await addDoc(collection(db,'notifications'), { title: 'New item posted', message: `${title} added to ${currentTab}.`, target:'all', itemId:null, createdAt: serverTimestamp(), readBy: [] });
      
      showToast('✅ Posted successfully!');
      
      // Send email notification to all users
      await sendEmailToAllUsers(`New ${currentTab} Item`, `${title} has been posted in ${currentTab} section!`);
      
      // Close modal and clear form
      modalAdd.classList.remove('show');
      singleBox.value=''; 
      fileInput.value='';
      
    } catch(e){ showToast('❌ Post failed: '+e.message); }
  };
  function fileToDataUrl(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
  // Email notification function
  async function sendEmailToAllUsers(subject, message) {
    try {
      // Get all users from Firestore
      const usersSnapshot = await getDocs(collection(db, 'users'));
      const users = usersSnapshot.docs.map(d => d.data());
      
      // Filter unique emails
      const emails = [...new Set(users.map(u => u.email).filter(e => e))];
      
      if(window.emailjs && EMAILJS_SERVICE_ID !== "YOUR_SERVICE_ID") {
        // Send email to each user
        for(const email of emails) {
          try {
            await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
              to_email: email,
              subject: subject,
              message: message,
              from_name: 'BBD Lost & Found'
            });
          } catch(e) {
            console.warn('Failed to send email to:', email, e);
          }
        }
        console.log('✅ Email notifications sent to', emails.length, 'users');
      } else {
        console.log('EmailJS not configured. Would send to:', emails.length, 'users');
      }
    } catch(e) {
      console.error('Failed to send email notifications:', e);
    }
  }
  // notifications
  function attachNotificationsListener(){
    if (notifsUnsub){ notifsUnsub(); notifsUnsub=null; }
    const q = query(collection(db,'notifications'), orderBy('createdAt','desc'), limit(80));
    notifsUnsub = onSnapshot(q, snap => {
      const arr = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      renderBadge(arr);
      if (notifPanel.classList.contains('show')) renderNotifPanel(arr);
    }, err => console.warn('notif listen err', err));
  }
  function renderBadge(list){
    if (!currentUser){ badge.style.display='none'; return; }
    const unread = list.filter(n => !Array.isArray(n.readBy) || !n.readBy.includes(currentUser.uid)).length;
    if (unread>0){ badge.style.display='flex'; badge.textContent = unread; } else { badge.style.display='none'; }
  }
  inboxBtn.onclick = ()=>{ notifPanel.classList.toggle('show'); }
  function renderNotifPanel(list){
    notifPanel.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><strong>Notifications</strong><button id="markAll" class="btn ghost">Mark all read</button></div>`;
    if (!list.length){ notifPanel.innerHTML += `<div class="small-muted">No notifications</div>`; return; }
    list.forEach(n => {
      const unread = !n.readBy || !n.readBy.includes(currentUser ? currentUser.uid : '___');
      const it = document.createElement('div'); it.className='notif-item ' + (unread ? 'unread' : '');
      it.innerHTML = `<div style="font-weight:700">${escapeHtml(n.title || 'Notice')}</div><div class="small-muted">${escapeHtml(n.message || '')}</div><div class="small-muted" style="margin-top:6px">${n.createdAt ? new Date(n.createdAt.seconds*1000).toLocaleString() : ''}</div>`;
      it.onclick = async ()=>{ if (!currentUser) return openAuthModal('login'); try { await updateDoc(doc(db,'notifications',n.id), { readBy: arrayUnion(currentUser.uid) }); } catch(e){ console.warn('mark read', e); } };
      notifPanel.appendChild(it);
    });
    const markAll = document.getElementById('markAll');
    markAll && (markAll.onclick = async ()=>{ if (!currentUser) return openAuthModal('login'); try { for (const n of list) { await updateDoc(doc(db,'notifications',n.id), { readBy: arrayUnion(currentUser.uid) }); } showToast('All marked read'); } catch(e){ showToast('❌ Mark all failed: '+e.message) } });
  }
  // particle burst
  function particleBurst({x=window.innerWidth/2, y=window.innerHeight/2, count=36} = {}){
    const particles = [];
    for (let i=0;i<count;i++) particles.push({ x, y, vx:(Math.random()-0.5)*6, vy:(Math.random()-1.2)*6, life:Math.random()*60+40, size:Math.random()*3+2, color:`hsl(${Math.random()*360},80%,60%)` });
    let anim;
    function step(){
      ctx.clearRect(0,0,pcanvas.width,pcanvas.height);
      let alive=false;
      for (const p of particles){
        if (p.life>0){ p.x+=p.vx; p.y+=p.vy; p.vy+=0.14; p.life--; ctx.globalAlpha=Math.max(0,p.life/80); ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill(); alive=true; }
      }
      if (alive) anim=requestAnimationFrame(step); else { cancelAnimationFrame(anim); ctx.clearRect(0,0,pcanvas.width,pcanvas.height); }
    }
    step();
  }
  // toasts
  function showToast(msg, t=2800){ const el=document.createElement('div'); el.className='toast'; el.textContent=msg; toastRoot.appendChild(el); requestAnimationFrame(()=>{ el.style.opacity='1'; el.style.transform='translateY(0)'; }); setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(8px)'; setTimeout(()=>el.remove(),300); }, t); }
  function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  // init listeners
  attachItemsListener(currentTab); attachNotificationsListener();
  // search debounce
  let stimer=null; search.addEventListener('input', ()=>{ clearTimeout(stimer); stimer=setTimeout(()=>attachItemsListener(currentTab), 300); });
  </script>
</body>
</html>
